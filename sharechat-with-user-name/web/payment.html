<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.gstatic.com https://i.postimg.cc https://api.qrserver.com data: blob: 'unsafe-inline' 'unsafe-eval';">
<meta name="theme-color" content="#2563eb">
<title>Payment - ShareChat</title>

<style>
*{
  box-sizing:border-box;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  -webkit-tap-highlight-color: transparent;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
body{
  margin:0;
  background:linear-gradient(180deg,#f1f5ff,#f8fafc);
  display:flex;
  justify-content:center;
  min-height:100vh;
  min-height:-webkit-fill-available;
}
.app{
  width:100%;
  max-width:420px;
  min-height:100vh;
  min-height:-webkit-fill-available;
  background:#fff;
  position:relative;
}

/* HEADER */
.header{
  display:flex;
  align-items:center;
  padding:16px;
  font-size:18px;
  font-weight:800;
  position:sticky;
  top:0;
  background:#fff;
  border-bottom:1px solid #eee;
  z-index:10;
  padding-top: max(16px, env(safe-area-inset-top));
  padding-left: max(16px, env(safe-area-inset-left));
  padding-right: max(16px, env(safe-area-inset-right));
}
.back{
  font-size:22px;
  margin-right:12px;
  cursor:pointer;
  width:44px;
  height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:50%;
  transition:background 0.2s;
}
.back:active{
  background:rgba(0,0,0,0.05);
}
.header-btn{
  margin-left:auto;
  background:#2563eb;
  color:#fff;
  border:none;
  padding:8px 16px;
  font-size:13px;
  font-weight:700;
  border-radius:999px;
  cursor:pointer;
  transition:opacity 0.2s;
}
.header-btn:active{
  opacity:0.8;
}

/* AMOUNT CARD */
.amount-card{
  margin:16px;
  background:#f8d257;
  color:#000;
  border-radius:18px;
  padding:22px;
  text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  margin-top: max(16px, env(safe-area-inset-top));
}
.amount-card .title{
  font-size:13px;
  opacity:.8;
  margin-bottom:8px;
}
.amount{
  font-size:36px;
  font-weight:900;
  line-height:1.2;
}
.bonus-tag{
  margin-top:12px;
  background:rgba(255,255,255,.6);
  padding:8px 18px;
  border-radius:999px;
  font-size:13px;
  font-weight:700;
  display:inline-block;
}

/* QR */
.qr-wrap{
  margin:0 16px 16px;
  background:#fff;
  border-radius:18px;
  padding:18px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  text-align:center;
}
.qr{
  width:230px;
  height:230px;
  margin:0 auto 14px;
  background:#000;
  border-radius:16px;
  padding:10px;
  position:relative;
  display: flex;
  align-items: center;
  justify-content: center;
}
.qr img{
  width:100%;
  height:100%;
  border-radius:12px;
  object-fit:contain;
}
.scan-text{
  font-size:14px;
  font-weight:700;
  margin-top:8px;
}

/* QR Loading */
.qr-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  color: white;
  text-align: center;
}
.spinner-small {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  margin-bottom: 10px;
}

/* FIELDS */
.field{
  margin:12px 16px;
  background:#fff;
  border-radius:16px;
  padding:14px 16px;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
}
.field label{
  font-size:11px;
  font-weight:800;
  color:#6b7280;
  margin-bottom:6px;
  display:block;
}
.upi{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:15px;
  font-weight:700;
  min-height:24px;
}
.upi span{
  color:#16a34a;
  cursor:pointer;
  padding:8px 12px;
  border-radius:8px;
  transition:background 0.2s;
  font-size:14px;
}
.upi span:active{
  background:rgba(22,163,74,0.1);
}

/* UTR INPUT SPECIAL */
.field input{
  width:100%;
  border:2px solid #e5e7eb;
  outline:none;
  font-size:16px;
  padding:12px 14px;
  border-radius:12px;
  transition:.2s;
  background:#fff;
  -webkit-appearance: none;
  appearance: none;
}
.field input:focus{
  border-color:#16a34a;
  box-shadow:0 0 0 3px rgba(22,163,74,.15);
}

/* BUTTONS */
.btn{
  margin:18px 16px;
  width:calc(100% - 32px);
  padding:18px;
  font-size:16px;
  font-weight:800;
  border:none;
  border-radius:16px;
  color:#fff;
  cursor:pointer;
  transition:transform 0.1s, opacity 0.2s;
  position:relative;
  overflow:hidden;
}
.btn::after{
  content:'';
  position:absolute;
  top:50%;
  left:50%;
  width:5px;
  height:5px;
  background:rgba(255,255,255,0.5);
  opacity:0;
  border-radius:100%;
  transform:scale(1,1) translate(-50%);
  transform-origin:50% 50%;
}
.btn:active::after{
  animation:ripple 0.6s ease-out;
}
@keyframes ripple{
  0%{transform:scale(0,0); opacity:0.5;}
  100%{transform:scale(40,40); opacity:0;}
}
#payNow{
  background:linear-gradient(135deg,#16a34a,#22c55e);
}
#confirmBtn{
  background:linear-gradient(135deg,#2563eb,#4f46e5);
}
.btn:active{
  transform:scale(0.98);
}
.btn:disabled{
  opacity:0.6;
  cursor:not-allowed;
  transform:none !important;
}
.hidden{display:none !important;}

/* SMS NOTIFICATION */
.sms-notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #22c55e;
  color: white;
  padding: 16px 20px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;
  text-align: center;
  z-index: 1000;
  box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
  max-width: calc(100% - 32px);
  width: 400px;
  animation: slideDown 0.4s ease;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
}

@keyframes slideDown {
  from {
    top: -100px;
    opacity: 0;
  }
  to {
    top: 20px;
    opacity: 1;
  }
}

/* LOADING SPINNER */
.spinner {
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  display: inline-block;
  vertical-align: middle;
  margin-right: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* SAFE AREA PADDING */
.safe-area-bottom {
  padding-bottom: env(safe-area-inset-bottom);
  height: env(safe-area-inset-bottom);
}

/* ERROR MESSAGE */
.error-message {
  color: #ef4444;
  font-size: 13px;
  margin: 4px 16px 0;
  display: none;
}
.error-message.show {
  display: block;
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="back" id="backBtn" role="button" aria-label="Go back">&larr;</div>
    <div>Payment</div>
    <button class="header-btn" aria-label="Secure payment">Secure</button>
  </div>

  <div class="amount-card">
    <div class="title">Total Amount to Pay</div>
    <div class="amount" id="amountDisplay">&#8377;90</div>
    <div class="bonus-tag" id="bonusDisplay">1000 Coins + 100 Bonus</div>
  </div>

  <div class="qr-wrap">
    <div class="qr" id="qrContainer">
      <!-- QR Code will be generated here -->
      <div class="qr-loading">
        <div class="spinner-small"></div>
        <div>Generating QR Code...</div>
      </div>
    </div>
    <div class="scan-text">Scan to Pay &#8377;<span id="qrAmount">90</span></div>
  </div>

  <div class="field">
    <label>UPI ID</label>
    <div class="upi">
      <div id="upiId">7526915404@ybl</div>
      <span id="copyBtn" role="button" aria-label="Copy UPI ID">Copy</span>
    </div>
  </div>

  <div class="field hidden" id="utrField">
    <label>ENTER TRANSACTION ID / UTR</label>
    <input type="text" id="utrInput" placeholder="e.g. 123456789012" inputmode="numeric" pattern="[0-9]*" maxlength="20">
    <div class="error-message" id="utrError">Please enter a valid Transaction ID</div>
  </div>

  <button class="btn" id="payNow">Pay Now</button>
  <button class="btn hidden" id="confirmBtn">
    <span class="spinner" id="confirmSpinner"></span>
    <span id="confirmText">Confirm Payment</span>
  </button>
  
  <div class="safe-area-bottom"></div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// Check if localStorage is available
function isLocalStorageAvailable() {
  try {
    const test = '__test__';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch (e) {
    return false;
  }
}

// Safe localStorage getter
function getLocalStorage(key, defaultValue) {
  if (!isLocalStorageAvailable()) {
    console.warn('localStorage not available');
    return defaultValue;
  }
  return localStorage.getItem(key) || defaultValue;
}

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyA0DsePbzGn1G9hYdmrx8JHZfhbl_ZVCLg",
  authDomain: "sharechat-73d84.firebaseapp.com",
  databaseURL: "https://sharechat-73d84-default-rtdb.firebaseio.com",
  projectId: "sharechat-73d84",
  storageBucket: "sharechat-73d84.firebasestorage.app",
  messagingSenderId: "271531106579",
  appId: "1:271531106579:web:dfbc8cb1ea074c2fb37ae6",
  measurementId: "G-8RFX5JBPT5"
};

// Initialize Firebase
try {
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
} catch (error) {
  console.error('Firebase initialization error:', error);
}

const db = firebase.firestore();

// Payment data from localStorage
const paymentAmount = getLocalStorage("paymentAmount", "90");
const paymentCoins = getLocalStorage("paymentCoins", "1000 Coins + 100 Bonus");
const userMobile = getLocalStorage("userMobile", "");
const userUsername = getLocalStorage("userUsername", "ShareChat User");

// Update display with actual values
document.getElementById("amountDisplay").textContent = '&#8377;' + paymentAmount;
document.getElementById("bonusDisplay").textContent = paymentCoins;

// DOM Elements
const qrContainer = document.getElementById('qrContainer');
const qrAmountText = document.getElementById('qrAmount');
const payNowBtn = document.getElementById('payNow');
const utrField = document.getElementById('utrField');
const confirmBtn = document.getElementById('confirmBtn');
const confirmText = document.getElementById('confirmText');
const confirmSpinner = document.getElementById('confirmSpinner');
const utrInput = document.getElementById('utrInput');
const utrError = document.getElementById('utrError');
const copyBtn = document.getElementById('copyBtn');
const upiIdElement = document.getElementById('upiId');
const backBtn = document.getElementById('backBtn');

// Hide spinner initially
confirmSpinner.style.display = 'none';

// Update QR amount text
qrAmountText.textContent = paymentAmount;

// Function to generate QR Code with amount
function generateQRCodeWithAmount(amount) {
  const upiId = "7526915404@ybl";
  const userName = userUsername.replace(/[^\w\s]/gi, '').substring(0, 20) || "ShareChatUser";
  
  // Create UPI payment string with exact amount
  const upiString = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(userName)}&am=${amount}&cu=INR&tn=ShareChat_Coins`;
  
  // Use reliable QR code API
  const qrSize = 230;
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(upiString)}&format=jpeg&qzone=2`;
  
  // Create image element
  const img = new Image();
  img.alt = 'QR Code for &#8377;' + amount;
  img.style.borderRadius = '12px';
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.objectFit = 'contain';
  
  // Show loading
  qrContainer.innerHTML = '<div class="qr-loading"><div class="spinner-small"></div><div>Generating QR Code...</div></div>';
  
  // When image loads
  img.onload = function() {
    qrContainer.innerHTML = '';
    qrContainer.appendChild(img);
    console.log('QR Code generated for amount:', amount);
  };
  
  // If image fails to load
  img.onerror = function() {
    console.error('Failed to load QR code');
    // Fallback: Show text with UPI details
    qrContainer.innerHTML = `
      <div style="color: white; text-align: center; padding: 20px;">
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">UPI Payment</div>
        <div style="font-size: 14px; margin-bottom: 5px;">Amount: &#8377;${amount}</div>
        <div style="font-size: 12px; margin-bottom: 5px;">UPI ID: ${upiId}</div>
        <div style="font-size: 11px; opacity: 0.8;">Copy UPI ID and pay manually</div>
      </div>
    `;
  };
  
  // Set image source
  img.src = qrUrl;
  
  // Store UPI link for Pay Now button
  qrContainer.dataset.upiLink = upiString;
  
  return upiString;
}

/* Pay Now */
payNowBtn.addEventListener('click', () => {
  try {
    const upiId = "7526915404@ybl";
    const userName = userUsername.replace(/[^\w\s]/gi, '').substring(0, 20) || "ShareChatUser";
    
    // Create UPI link with exact amount
    const upiLink = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(userName)}&am=${paymentAmount}&cu=INR&tn=ShareChat_Coins`;
    
    // Try to open UPI app
    window.location.href = upiLink;
    
    // Fallback for if UPI app doesn't open
    setTimeout(() => {
      // Check if we're still on the same page
      if (window.location.href.includes('payment.html')) {
        // Show manual UPI details
        utrField.classList.remove('hidden');
        confirmBtn.classList.remove('hidden');
        payNowBtn.classList.add('hidden');
        utrInput.focus();
        
        // Show instruction
        alert('If UPI app did not open, please:\n1. Copy the UPI ID: ' + upiId + '\n2. Open your UPI app manually\n3. Paste the UPI ID and pay &#8377;' + paymentAmount);
      }
    }, 1000);
  } catch (error) {
    console.error('Error opening UPI:', error);
    // Direct fallback
    utrField.classList.remove('hidden');
    confirmBtn.classList.remove('hidden');
    payNowBtn.classList.add('hidden');
    utrInput.focus();
  }
});

/* Copy UPI */
copyBtn.addEventListener('click', async () => {
  try {
    await navigator.clipboard.writeText(upiIdElement.innerText);
    const originalText = copyBtn.innerText;
    copyBtn.innerText = "&#10003; Copied";
    copyBtn.style.color = "#059669";
    
    setTimeout(() => {
      copyBtn.innerText = originalText;
      copyBtn.style.color = "#16a34a";
    }, 2000);
  } catch (error) {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = upiIdElement.innerText;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    
    const originalText = copyBtn.innerText;
    copyBtn.innerText = "&#10003; Copied";
    copyBtn.style.color = "#059669";
    
    setTimeout(() => {
      copyBtn.innerText = originalText;
      copyBtn.style.color = "#16a34a";
    }, 2000);
  }
});

/* UTR Input Validation */
utrInput.addEventListener('input', () => {
  const value = utrInput.value.trim();
  if (value.length >= 12) {
    utrError.classList.remove('show');
    utrInput.style.borderColor = '#16a34a';
  } else if (value.length > 0 && value.length < 12) {
    utrError.classList.add('show');
    utrInput.style.borderColor = '#ef4444';
  } else {
    utrError.classList.remove('show');
    utrInput.style.borderColor = '#e5e7eb';
  }
});

/* Confirm Payment */
confirmBtn.addEventListener('click', async () => {
  const utr = utrInput.value.trim();
  
  // Validation
  if (!utr) {
    utrError.textContent = "Please enter your Transaction ID / UTR";
    utrError.classList.add('show');
    utrInput.focus();
    utrInput.style.borderColor = '#ef4444';
    return;
  }
  
  if (utr.length < 12) {
    utrError.textContent = "Transaction ID must be at least 12 characters";
    utrError.classList.add('show');
    utrInput.focus();
    utrInput.style.borderColor = '#ef4444';
    return;
  }
  
  // Show loading state
  confirmBtn.disabled = true;
  confirmText.textContent = "Processing...";
  confirmSpinner.style.display = 'inline-block';

  try {
    // Save payment data to Firebase
    const paymentData = {
      userMobile: userMobile,
      userUsername: userUsername,
      amount: paymentAmount,
      coins: paymentCoins,
      utr: utr,
      status: "pending",
      userAgent: navigator.userAgent,
      timestamp: new Date().toISOString(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    const docRef = await db.collection("payments").add(paymentData);
    console.log("Payment saved with ID: ", docRef.id);

    // Show SMS notification
    const sms = document.createElement('div');
    sms.className = 'sms-notification';
    sms.setAttribute('role', 'alert');
    sms.innerHTML = `
      <div style="font-size:16px; margin-bottom:5px; font-weight:700;">&#10003; Payment Received</div>
      <div style="font-size:13px; opacity:0.95;">Your ${paymentCoins} will be credited within 5-10 minutes. Transaction ID: ${utr}</div>
    `;
    
    document.body.appendChild(sms);
    
    // Clear local storage payment data
    if (isLocalStorageAvailable()) {
      localStorage.removeItem("paymentAmount");
      localStorage.removeItem("paymentCoins");
    }
    
    // After 4 seconds, redirect back to profile
    setTimeout(() => {
      sms.style.animation = 'slideDown 0.4s ease reverse';
      setTimeout(() => {
        sms.remove();
        window.location.href = "profile.html";
      }, 400);
    }, 4000);
    
  } catch (error) {
    console.error("Error saving payment: ", error);
    
    // Reset button state
    confirmBtn.disabled = false;
    confirmText.textContent = "Confirm Payment";
    confirmSpinner.style.display = 'none';
    
    // Show error
    utrError.textContent = "Network error. Please check connection and try again.";
    utrError.classList.add('show');
    
    // Show error notification
    const errorNotification = document.createElement('div');
    errorNotification.className = 'sms-notification';
    errorNotification.style.background = '#ef4444';
    errorNotification.style.boxShadow = '0 8px 25px rgba(239, 68, 68, 0.4)';
    errorNotification.innerHTML = `
      <div style="font-size:16px; margin-bottom:5px; font-weight:700;">&#10007; Payment Failed</div>
      <div style="font-size:13px; opacity:0.95;">Please try again or contact support.</div>
    `;
    
    document.body.appendChild(errorNotification);
    
    setTimeout(() => {
      errorNotification.style.animation = 'slideDown 0.4s ease reverse';
      setTimeout(() => errorNotification.remove(), 400);
    }, 3000);
  }
});

/* Back Button */
backBtn.addEventListener('click', () => {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = "profile.html";
  }
});

/* Handle Android back button */
document.addEventListener('keydown', (e) => {
  if (e.key === 'Backspace' || e.key === 'Escape') {
    e.preventDefault();
    backBtn.click();
  }
});

/* Prevent zoom on input focus */
utrInput.addEventListener('focus', () => {
  setTimeout(() => {
    document.body.style.zoom = "1";
  }, 100);
});

/* Initialize */
document.addEventListener('DOMContentLoaded', () => {
  // Add loading class to body
  document.body.classList.add('loaded');
  
  // Log for debugging
  console.log('Payment page loaded for:', userMobile || 'Unknown user');
  console.log('Amount:', paymentAmount, 'Coins:', paymentCoins);
  
  // Generate QR Code with amount
  setTimeout(() => {
    generateQRCodeWithAmount(paymentAmount);
  }, 500);
});
</script>

</body>
</html>
